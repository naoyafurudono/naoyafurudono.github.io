---
title: "契約と型検査"
date: 2023-08-31T21:49:38+09:00
author: "Naoya Furudono"
draft: false
tags: [
    ,"PL"
    ,"tech"
    ,"alcohol"
]
---

プログラミングの型について書きます。
お酒を飲みながら書きました。注意は払ったつもりですが、変なところがあるかもしれません。

- 契約とは何か
  - 例を含める
- どんな嬉しさがあるか
- 型検査との兼ね合い

# 契約とは何か

契約 (contract) とはプラグラムの関数の入出力に関する規約のことです。
例えば整数の割り算をする `div` 関数は、二つの整数を受け取って商を返す関数だとしましょう。
このとき、入力の二つの値は

1. どちらも整数
1. 二つ目の整数は0ではない

ことが求められます。
また、整数の割り算を行なっているので、`div(a,b)` の値は例えば

1. `a` の絶対値以下であること

が求められます。
箇条書きで示したような `div` 関数について求められる性質のことを契約とよぶことが多いです。

ここまでで例を示しました。例のことは忘れて一旦抽象的な定義を試みましょう。
契約は関数を呼び出す側と呼ばれる定義の間の約束事です。
関数を__正しく__呼べば__正しい結果__を返すことを規定します。
どんな呼び出しが正しくて、どんな結果が正しいかを規定するのが契約です。

例えば `div` 関数の第二引数に0を渡すのは呼び出し側の契約違反で、
`div(168,4)` の結果が42にならないのは関数定義の契約違反です。

その辺の言語では関数の冒頭で引数のチェックをして、呼び出し側の責任を追及するスタイルでコードを書くことになりがちですが、
言語によっては組み込みの機能でいい感じに契約を書いて、実行時に検査できます。
D言語とかRacketがいい例です。

# 契約の嬉しさ

契約を書いておくと何が嬉しいでしょうか。
問題の切り分けが楽になることが嬉しいですね。
[Blame shifting](https://dl.acm.org/doi/10.1145/3371133)ができます。
みなさん人生で一回は `Segmentation fault` とか `Null pointer exception` とか `car: cannot apply for nil` みたなエラーに遭遇したことがあるかと思います。
これらのエラーは契約をちゃんと関数に書いていないから起きるはずで、
まともなライブラリを使っていればあまりみないはずです。
これらのエラーが出たときには割と深く絶望して、どの関数が悪さをしているか探す旅が始まります。

もし真面目に契約を書いていれば関数が許さないnilを受け取った時点で呼び出し側に責任があることを保証したり、関数の実装がおかしくて、間違った振る舞いをしていることがわかります。

これが契約の嬉しさです。反対に、関数を動かして契約違反で怒られない限り、その契約を実装が遵守していることが保証されます。これもまた契約の嬉しさの一つです。契約はプロダクション環境で生きているドキュメントとして機能します。

テストとの違いは、契約は実行時に検査をすることが大きいでしょう。
テストはテストを走らせるときにしか検証を行いませんが、
契約は実行時にも検査を行います。

# 型検査との兼ね合い

契約はいいものであることがわかったと思います
関数定義の性質を保証して、何かあれば__すぐに__検出し、
何もなければ、すべてのそれまでの実行で違反したケースがないことを保証します。

この観点で見たときに、型検査はテストよりも契約に近しい存在だと言えるでしょう。
型検査は、コンパイルのたびに型制約が満たされていることを検証します。
健全な（まともな）型システムでは、型検査をパスしたプログラムは実行時に型エラーを起こさないことが保証されます（この保証がある型システムのことを健全だというので順番は逆ですが）。
型検査では、関数の入力として渡される値が、関数が期待する条件を満たすことを検査しますし、
関数が返す値が宣言にあっていることも検査します。
したがって、契約は実行時に検査を行う一方で、型検査はコンパイル時に行います。

逆にいうと、契約は型検査で静的にやろうとする検査を実行時まで遅延したものです。
実行時には任意の計算をできるので表現力は契約の方が高いです。例えば引数の値が10と20の間である、
みたいなことを検査するのは型検査では大変ですが、契約ならちょちょいのちょいです。

じゃあ契約だけでいいじゃないか、型検査なんてやめてしまえ！という話になるかというと、
そうは問屋が卸しません。

型検査の良さは静的に検証が済むことにあります。
つまり、以下の二つを型検査は満たします

1. 全ての実行について、検証結果が成立する
1. プログラムを実行しないでも検証を行える

契約やテストでは、実行した場合については動作を検証してくれますが、
それとは違う値については特に保証をしてくれません。
だから境界テストみたいな、人間が上手に動かす技法が使われるのでしょう。
型検査では、ある程度検証内容を抽象的にしたり保守的にすることで、全ての実行に対する性質を保証します。
intが返る関数は決してfloatを返さないことを型検査では保証できます。

抽象化や保守的な検査を行う二つ目の恩恵として、実行しないでも検証できることが挙げられます。
本番環境で動かさないとわからなかったり、テスト環境をせっせと用意する必要は、型検査では生じません。

## テストはいらない？

テストは必要です。型検査や契約があるからといってテストが入らなくなることはありません。
実際に色々なケースで動かすことは必要なはずです。

それでも全ての異常の検知をテストでまかなう必要もないはずです。
契約や型検査は保証をする仕組みとして優秀です。
基本的な保証は契約や型検査で済ませて、本当に際どいところをテストでカバーする、みたいな役割分担をすると幸せになれるんじゃないかと思います。


