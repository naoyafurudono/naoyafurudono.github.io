---
title: "エフェクトハンドラの良さと実用性について"
date: 2023-03-16T10:57:18+09:00
author: "Naoya Furudono"
draft: false
tags: [
    "PL"
    ,"tech"
    ,"idea"
    ,"tool"
]
---

エフェクトハンドラで継続や代数的エフェクトを扱う必要性は一ミリもなくて、
実用的にそれらが欲しくなることはないか、
あるいは限られていてそこまで一般的な機能を提供する必要はないんじゃないかと感じている。

このあたりを議論するために

1. エフェクトハンドラの嬉しさ
1. 意味論の歴史的経緯
1. 改善ポイント

を考える。

なお、この記事はとくに裏付けもなく書いている。
気が向いたら裏付けをしようと思っているが、
この記事の目的は僕の考えの整理であって、世に主張をしたいわけではない。

記事の内容は不正確なことを留意されたい。


## エフェクトハンドラの嬉しさ

エフェクトハンドラが実際的 (practical) なプログラミング言語でエンドユーザに使わせたくなるのは

- エフェクトシステムと相性のよい意味論
- 動的束縛

を提供したいからではないだろうか。
エフェクトハンドラを言語に入れれば、それで表現できる操作は自動的にエフェクトシステムで追跡できるし、
ハンドラを用いることでエフェクトをローカルに使えるのは特筆するべきだろう。
汎用性とlocal reasoningのしやすさはエフェクトハンドラのもつ良い性質だと思う。

エフェクトハンドラで実現できる動的束縛はとても使い勝手が良い上に、
エフェクトシステムで追跡することで使い勝手が上がりそうだ。
動的束縛のためだけのエフェクトシステムではなく、もう少し凝ったことができるエフェクトシステムがつくとなお幸せだろうから、エフェクトハンドラみたいな抽象度の比較的高いフレームワークで実現するのは幸せなんじゃないかと感じる。

## 意味論の歴史的経緯

エフェクトハンドラと呼ばずに "algebraic effects" とか "algebraic effects and handlers"
とか呼ぶ流派、時代がある。
歴史的には

- algebraic effects
- algebraic effects and handlers
- effect handlers

みたいな流れで登場したはずだ。
最初はハンドラはなくて、モナドとかの話をするような人たちが副作用にモナドではない別の表現を与えようとしたんだったか。
ここでいうモナドはモナド則とかを真面目に考えるような数学のモナド。代数的エフェクトもその流れの中に（このころは）あったはず。
そもそも代数的エフェクトの代数とは、操作が（0だか1こ以上）あって、それらに等式制約を課す。それを満たすようなモデルを持つのが代数 (algebra) である、みたいな世界だっと思う。群とか環は代数だけど、体は代数じゃないみたいな話を聞いたことがある。
そういうのりの代数として、エフェクトを表現したらモナドの合成みたいなことを考えるときに幸せだ、という主張がことの発端だった気がする。

ここまでは数学とかモデル理論？とかの話によっていて、あまりプログラミング言語っぽい雰囲気がしない。
ハンドラとか継続が入ってきた経緯はしらないが、多分、プログラミング言語に代数的エフェクトを入れるにあたって、
モナドのbindやreturnみたいなものを定義するように、エフェクトに意味を与える仕組みとしてハンドラが考えられたんじゃないかと思う。
このあたりは論文をまじめに読めば分かるはず。
これが確か2014年くらいのこと。

2000年くらいだったかから考えられていたエフェクトシステムとの相性に目をつけたからか知らないが、
「代数的エフェクトとハンドラ」を取り入れた言語が2014年ころに登場し始める。2017年くらいにでてくる印象がある。
EffやKokaはこのへんな気がする。
このあたりで、エフェクトが代数的であることはとくに気にされなくなっていき、エフェクトシステムと例外ハンドラがうまいこと組み合わさる限定継続演算子くらいの気持ちで代数的エフェクトとそのハンドラが捉えられて、
やがて代数的ではないことが気になる人々がエフェクトハンドラと呼ぶようになったのではないかと思っている。

## 改善ポイント

限定継続は本当に必要だろうか。
もっとやさしい概念を提供するのにとどめるのはいかがだろうか。ワンショット継続とかに限定する言語もあるが、それは正しい方向性だろうか。

僕たちがほしかったものは、local reasoningしやすいエフェクトシステムとそれで健全に管理できる意味論なんじゃないかと思う。
エフェクトハンドラはその条件を満たすけど、もっと使い心地のよい意味論があるはずだと思う。

## あとがき

最後の文をメモしたくてこの記事を書いた。それ以外は文脈である。
