<!doctype html><html lang=ja><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>SQL エフェクト | ツイートするには長すぎる</title><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=manifest href=/images/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/images/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta property="og:url" content="https://blog.nfurudono.com/posts/sql-effect/"><meta property="og:site_name" content="ツイートするには長すぎる"><meta property="og:title" content="SQL エフェクト"><meta property="og:description" content="追記: 簡単に行けそうとか書いたが、ちゃんと面倒だった
GoとsqlcでAPIサーバを開発している。責務がデカくなってくると、モジュラモノリスみたいに責務をパッケージに切りたくなる。データベースのテーブルもへんなパッケージから参照されると困るので、パッケージの分割をテーブル集合の分割に対応させてメンテナンスしたい。"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-19T13:43:20+09:00"><meta property="article:modified_time" content="2025-07-20T20:52:34+09:00"><meta property="article:tag" content="Daily"><meta property="article:tag" content="PL"><meta property="article:tag" content="Tech"><meta property="article:tag" content="Idea"><meta property="article:tag" content="Tool"><meta property="og:image" content="https://blog.nfurudono.com/images/thumbnail.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.nfurudono.com/images/thumbnail.png"><meta name=twitter:title content="SQL エフェクト"><meta name=twitter:description content="追記: 簡単に行けそうとか書いたが、ちゃんと面倒だった
GoとsqlcでAPIサーバを開発している。責務がデカくなってくると、モジュラモノリスみたいに責務をパッケージに切りたくなる。データベースのテーブルもへんなパッケージから参照されると困るので、パッケージの分割をテーブル集合の分割に対応させてメンテナンスしたい。"><meta name=description content="追記: 簡単に行けそうとか書いたが、ちゃんと面倒だった
GoとsqlcでAPIサーバを開発している。責務がデカくなってくると、モジュラモノリスみたいに責務をパッケージに切りたくなる。データベースのテーブルもへんなパッケージから参照されると困るので、パッケージの分割をテーブル集合の分割に対応させてメンテナンスしたい。..."><meta property="og:description" content="追記: 簡単に行けそうとか書いたが、ちゃんと面倒だった
GoとsqlcでAPIサーバを開発している。責務がデカくなってくると、モジュラモノリスみたいに責務をパッケージに切りたくなる。データベースのテーブルもへんなパッケージから参照されると困るので、パッケージの分割をテーブル集合の分割に対応させてメンテナンスしたい。..."><meta name=twitter:description content="追記: 簡単に行けそうとか書いたが、ちゃんと面倒だった
GoとsqlcでAPIサーバを開発している。責務がデカくなってくると、モジュラモノリスみたいに責務をパッケージに切りたくなる。データベースのテーブルもへんなパッケージから参照されると困るので、パッケージの分割をテーブル集合の分割に対応させてメンテナンスしたい。..."><link rel=stylesheet href=https://blog.nfurudono.com/css/main.min.680546ad85e4ae010fb2c6d6e29f48227e146cc09f57f4dc75b7ae0782d1139e.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-ES42FPF4D5"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ES42FPF4D5")}</script></head><body><nav><header><div class=site-title><a href=/>ツイートするには長すぎる</a></div></header><div class=nav-menu><a class="color-link nav-link" href=/profile/>Profile</a>
<a class="color-link nav-link" href=/tags/>Tags</a>
<a class="color-link nav-link" href=/about/>about</a>
<a class="color-link nav-link" href target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons><a class=social-icon href=https://twitter.com/furudono2 target=_blank rel=noopener title=Twitter><svg width="28" height="28" viewBox="0 0 28 28" fill="#ABABAB" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M8.991284 24.971612c10.189152.0 15.761088-8.441388 15.761088-15.761088C24.752372 8.970656 24.747512 8.731868 24.736496 8.494376 25.818008 7.712564 26.758256 6.737 27.5 5.62622c-.992628.440856-2.060748.738072-3.181248.871992 1.14372-.685584 2.02176-1.770768 2.435832-3.064176-1.070496.6345-2.25558 1.095984-3.517344 1.344492-1.010772-1.076652-2.450412-1.75014-4.043412-1.75014-3.059424.0-5.540292 2.480868-5.540292 5.539104.0.434808.0487079999999995.857412.14364 1.26306C9.19346 9.599108 5.11106 7.39472 2.3792 4.04294c-.476172.818424-.750168 1.769688-.750168 2.784132.0 1.921968.97794 3.61854 2.464992 4.61106C3.185528 11.41016 2.331788 11.160464 1.585184 10.745096 1.583888 10.768208 1.583888 10.791428 1.583888 10.815728c0 2.683152 1.909764 4.922856 4.4442 5.43078C5.562932 16.373084 5.07326 16.44134 4.56782 16.44134 4.210988 16.44134 3.863876 16.406024 3.526484 16.34144c.70524 2.200824 2.750112 3.802356 5.174928 3.8475-1.896264 1.485756-4.284576 2.37114-6.879924 2.37114C1.374476 22.56008.93362 22.534592.5 22.4834c2.451708 1.571076 5.362524 2.488212 8.491284 2.488212"/></svg>
</a><a class=social-icon href=https://www.instagram.com/donofuru/ target=_blank rel=noopener title=Instagram><svg width="28" height="28" viewBox="0 0 28 28" fill="#ABABAB" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M14.0000238 2.00378571c3.2579524.0 3.6664762.0138095300000001 4.946.0721904800000002C20.222881 2.13421429 21.0949286 2.33702381 21.8579762 2.63359524 22.6468333 2.94011905 23.3158333 3.35030952 23.9827857 4.01721429 24.6496905 4.68416667 25.059881 5.35316667 25.3664524 6.14202381 25.6629762 6.90507143 25.8657857 7.77711905 25.9240238 9.05397619 25.9824048 10.3335 25.9962143 10.7420238 25.9962143 14.0000238 25.9962143 17.2579762 25.9824048 17.6665 25.9240238 18.9460238 25.8657857 20.222881 25.6629762 21.0949286 25.3664524 21.8579762 25.059881 22.6468333 24.6496905 23.3158333 23.9827857 23.9827857 23.3158333 24.6496905 22.6468333 25.059881 21.8579762 25.3664524 21.0949286 25.6629762 20.222881 25.8657857 18.9460238 25.9240238 17.6665 25.9824048 17.2579762 25.9962143 14.0000238 25.9962143 10.7420238 25.9962143 10.3335 25.9824048 9.05397619 25.9240238 7.77711905 25.8657857 6.90507143 25.6629762 6.14202381 25.3664524 5.35316667 25.059881 4.68416667 24.6496905 4.01721429 23.9827857c-.66690477-.6669524-1.07709524-1.3359524-1.38361905-2.1248095-.29657143-.7630476-.49938095-1.6350952-.55761905-2.9119524C2.01759524 17.6665 2.00378571 17.2579762 2.00378571 14.0000238 2.00378571 10.7420238 2.01759524 10.3335 2.07597619 9.05397619 2.13421429 7.77711905 2.33702381 6.90507143 2.63359524 6.14202381c.30652381-.78885714.71671428-1.45785714 1.38361905-2.12480952.66695238-.66690477 1.33595238-1.07709524 2.12480952-1.38361905C6.90507143 2.33702381 7.77711905 2.13421429 9.05397619 2.07597619 10.3335 2.01759524 10.7420238 2.00378571 14.0000238 2.00378571zm0 2.16147619C10.796881 4.1652619 10.4174524 4.1775 9.1525 4.23521429 7.98288095 4.28854762 7.34769048 4.48397619 6.92497619 4.6482619 6.36502381 4.86588095 5.96540476 5.12583333 5.54564286 5.54564286c-.41980953.4197619-.67976191.81938095-.89738096 1.37933333-.16428571.42271429-.35971428 1.05790476-.41304761 2.22752381C4.1775 10.4174524 4.1652619 10.796881 4.1652619 14.0000238 4.1652619 17.203119 4.1775 17.5825476 4.23521429 18.8475 4.28854762 20.017119 4.48397619 20.6523095 4.6482619 21.0750238 4.86588095 21.6349762 5.12588095 22.0345952 5.54564286 22.4543571 5.96540476 22.8741667 6.36502381 23.134119 6.92497619 23.3517381 7.34769048 23.5160238 7.98288095 23.7114524 9.1525 23.7647857 10.4173095 23.8225 10.7966429 23.8347381 14.0000238 23.8347381 17.2033571 23.8347381 17.5827381 23.8225 18.8475 23.7647857 20.017119 23.7114524 20.6523095 23.5160238 21.0750238 23.3517381 21.6349762 23.134119 22.0345952 22.8741667 22.4543571 22.4543571 22.8741667 22.0345952 23.134119 21.6349762 23.3517381 21.0750238 23.5160238 20.6523095 23.7114524 20.017119 23.7647857 18.8475 23.8225 17.5825476 23.8347381 17.203119 23.8347381 14.0000238 23.8347381 10.796881 23.8225 10.4174524 23.7647857 9.1525 23.7114524 7.98288095 23.5160238 7.34769048 23.3517381 6.92497619 23.134119 6.36502381 22.8741667 5.96540476 22.4543571 5.54564286 22.0345952 5.12583333 21.6349762 4.86588095 21.0750238 4.6482619 20.6523095 4.48397619 20.017119 4.28854762 18.8475 4.23521429 17.5825476 4.1775 17.203119 4.1652619 14.0000238 4.1652619zm0 13.8334762c2.2084286.0 3.9987143-1.7902857 3.9987143-3.9987143.0-2.2084762-1.7902857-3.9987619-3.9987143-3.9987619-2.2084762.0-3.9987619 1.7902857-3.9987619 3.9987619.0 2.2084286 1.7902857 3.9987143 3.9987619 3.9987143zm0-10.15895239c3.4021905.0 6.1601905 2.75799999 6.1601905 6.16023809.0 3.4021905-2.758 6.1601905-6.1601905 6.1601905-3.4022381.0-6.16023809-2.758-6.16023809-6.1601905.0-3.4022381 2.75799999-6.16023809 6.16023809-6.16023809zm7.8431429-.24338095c0 .79504762-.644523800000002 1.43952381-1.4395715 1.43952381C19.6085952 9.03592857 18.9640714 8.39145238 18.9640714 7.59640476S19.6085952 6.15683333 20.4035952 6.15683333c.795047699999998.0 1.4395715.64452381 1.4395715 1.43957143z"/></svg>
</a><a class=social-icon href=https://www.linkedin.com/in/naoya-furudono target=_blank rel=noopener title=LinkedIn><svg width="28" height="28" viewBox="0 0 28 28" fill="#ABABAB" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M2 3.654102c0-.95502059.79442509-1.73012354 1.77383592-1.73012354H24.2261641C25.2058917 1.92397846 26 2.69908141 26 3.654102V24.3462148C26 25.3015521 25.2058917 26.0760215 24.2261641 26.0760215H3.77383592C2.79442509 26.0760215 2 25.3015521 2 24.3465315V3.65378524 3.654102zM9.27526132 22.1415901V11.2356668H5.65030092V22.1415901H9.27557808 9.27526132zM7.46341463 9.74691162c1.2638581.0 2.05068103-.83750395 2.05068103-1.88406715C9.49033893 6.79252455 8.72727273 5.97846056 7.48748812 5.97846056c-1.24073487.0-2.05099778.81406399-2.05099778 1.88438391.0 1.0465632.78650618 1.88406715 2.00316756 1.88406715h.02343998H7.46341463zM11.2815965 22.1415901h3.6246436v-6.089642C14.9062401 15.7263225 14.9299968 15.4000634 15.0256573 15.1675641c.261957499999999-.6515679.8584099-1.3259423 1.8599936-1.3259423 1.3113716.0 1.836237 1 1.836237 2.4662654v5.8337029h3.6246436V15.8885017c0-3.349699-1.7880899-4.9084574-4.172949-4.9084574-1.9553373.0-2.814064 1.0928097-3.2910991 1.8371872H14.9065569v-1.581248H11.2819132C11.3291099 12.2591067 11.2815965 22.1419069 11.2815965 22.1419069V22.1415901z"/></svg>
</a><a class=social-icon href=https://github.com/naoyafurudono target=_blank rel=noopener title=GitHub><svg width="28" height="28" viewBox="0 0 28 28" fill="#ABABAB" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M13.9988029 1.32087331C6.82105037 1.32087331 1 7.14112562 1 14.3212723c0 5.7436386 3.72454649 10.6157955 8.89038951 12.3348169C10.5408085 26.7757983 10.7778323 26.374374 10.7778323 26.0296121 10.7778323 25.7215609 10.7666595 24.9035493 10.760275 23.8189856 7.14426471 24.6042767 6.38131925 22.0760223 6.38131925 22.0760223c-.59136253-1.5019491-1.44369072-1.9017772-1.44369072-1.9017772C3.75729765 19.3682044 5.02701126 19.3841656 5.02701126 19.3841656 6.33183953 19.4759425 7.01817121 20.7241085 7.01817121 20.7241085c1.15958133 1.9863716 3.04300319 1.4125664 3.78360289 1.0797753.1181129-.8395592.4540962-1.4125663.8251942-1.7373768C8.74038491 19.7385043 5.70536235 18.6228163 5.70536235 13.6413251c0-1.4189508.50676816-2.5801283 1.33834679-3.4883207C6.90963504 9.82420367 6.46351945 8.50181809 7.17139875 6.71256734c0 0 1.09094816-.34955032 3.57451115 1.33276037C11.78259 7.75642995 12.8950858 7.61277914 14.000399 7.60719272 15.1049142 7.61277914 16.2166119 7.75642995 17.2548881 8.04532771c2.4819669-1.68231069 3.571319-1.33276037 3.571319-1.33276037C21.5356825 8.50181809 21.0895669 9.82420367 20.9562909 10.1530044 21.7894656 11.0611968 22.2922435 12.2223743 22.2922435 13.6413251c0 4.9942601-3.039811 6.0931889-5.935173 6.4148071.4660671.401424200000001.8818564 1.194696.8818564 2.4077473C17.2389269 24.2012564 17.2229657 25.603448 17.2229657 26.0296121 17.2229657 26.3775663 17.4575954 26.7821827 18.116793 26.6552912 23.2786458 24.9322794 27 20.0633148 27 14.3212723 27 7.14112562 21.1789496 1.32087331 13.9988029 1.32087331"/></svg></a></div><p><a href=https://github.com/naoyafurudono/naoyafurudono.github.io target=_blank rel=noopener>source of this site</a></p><p><a href=https://gohugo.io target=_blank rel=noopener></a></p><p>©2025 Naoya Furudono</p><script src=https://blog.nfurudono.com/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script><a target=_blank rel="noopener noreferrer" href=https://github.com/naoyafurudono/naoyafurudono.github.io/actions><img src=https://github.com/naoyafurudono/naoyafurudono.github.io/actions/workflows/gh-pages.yml/badge.svg alt="github pages deploy status" style=max-width:100%></a><p><a href="https://www.amazon.jp/hz/wishlist/ls/1JBRXP4JZZ21T?ref_=wl_share">欲しい本リスト</a></p><p><a href="https://www.amazon.jp/hz/wishlist/ls/3TT5GR81VZPHP?ref_=wl_share">欲しいものリスト</a></p></footer></nav><div id=content class=content-container><h1 class=post-title>SQL エフェクト</h1><time>2025-07-19 +0900</time>
<time>updated: 2025-07-20 +0900</time><div class=page-header><a class=tag href=/tags/daily>#daily</a>
<a class=tag href=/tags/pl>#PL</a>
<a class=tag href=/tags/tech>#tech</a>
<a class=tag href=/tags/idea>#idea</a>
<a class=tag href=/tags/tool>#tool</a><hr class=header-divider></div><div><p><p>追記: 簡単に行けそうとか書いたが、ちゃんと面倒だった</p><p>GoとsqlcでAPIサーバを開発している。責務がデカくなってくると、モジュラモノリスみたいに責務をパッケージに切りたくなる。データベースのテーブルもへんなパッケージから参照されると困るので、パッケージの分割をテーブル集合の分割に対応させてメンテナンスしたい。</p><p>このコンポーネントはこれらのテーブルを所有していて、こっちのコンポーネントはこれらのコンポーネントを参照する、といったメンタルモデルを持っている。それを明示的に表明したいし、間違ったときに指摘したいということ。</p><p>そこで考えているのがエフェクトシステムのアイデアを借用したあれこれ。</p><h2><a href=#%e3%82%a8%e3%83%95%e3%82%a7%e3%82%af%e3%83%88%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%81%bd%e3%81%84%e6%96%b9%e5%bc%8f%e3%82%92%e7%94%a8%e3%81%84%e3%82%8b%e3%82%a2%e3%82%a4%e3%83%87%e3%82%a2 id=エフェクトシステムぽい方式を用いるアイデア class=anchor aria-hidden=true>エフェクトシステムぽい方式を用いるアイデア</a></h2><p>関数、型、パッケージごとに、それらを使用した際にどんなテーブル操作が作用するかを計算する。例えば、「関数ListOrganizationMemberはuser, member, organizationのテーブルをselectする」ことを計算する。</p><p>そのような作用が計算できれば「このパッケージでは、user, member, organizationのテーブルをselect, insert, deleteする」ことを別途表明しておくことで、実際に計算されたパッケージが引き起こす作用がその表明を満たすことを検証できる。</p><p>以下はその例である。 <code>// effect: ...</code> の行で関数や型、パッケージについての表明を行う。<code>repository</code> パッケージのメソッドを <code>SyncMembership</code> で呼び出している。これらの関数にも別途表明が書かれており、それを元にツールは <code>SyncMembership</code> で引き起こされる作用を（保守的に）計算する。その計算結果の作用が表明を満たすことを検証する。</p><p>反対に、もっともそれらしい表明を計算された作用から導出することもできる。</p><p>エイリアスとして <code>own = select, insert, delete</code> とか、<code>refer = select</code>、<code>mut = insert, update</code> とか（内容はてきとう）を定義してもいいだろう。</p><pre><code class=language-go>// effect: select&lt;user, member, organization&gt; insert&lt;member&gt;, delete&lt;member&gt;
package org_service

// OrgServiceは組織に関連するサービスを提供する。
// effect: select&lt;user, member, organization&gt; insert&lt;member&gt;, delete&lt;member&gt;
type OrgService struct {
  repository repository.Repository
}

// effect: select&lt;user, member. organization&gt;, insert&lt;member&gt;, delete&lt;member&gt;
func (o *OrgService) SyncMembership(org organization, users []user) error {
  current, err := repository.ListOrganizationMember(org.name)
  if err != nil { return err }

  toBe := lo.map(users, getID)
  toAdd := set.Diff(toBe, current)
  toRemove := set.Diff(current, toBe)

  for _, uid := range toAdd {
    if err := repository.AddMember(org.name, uid); err != nil { return err }
  }
  for _, uid := range toRemove {
    if err := repository.RemoveMember(org.name, uid); err != nil { return err }
  }
  return nil
}
</code></pre><h2><a href=#%e5%ae%9f%e7%8f%be%e6%96%b9%e9%87%9d id=実現方針 class=anchor aria-hidden=true>実現方針</a></h2><p>エフェクトシステム自体は特に新しいアイデアではない。簡単なはずなのでここでは扱わない。
SQLクエリを発行するルートのGo関数にエフェクトをつけることがネックで、なんとかしてsqlcが生成したコードに対してエフェクトをつける必要がある。プラグインでは素直にはできない。</p><p>以下のようなSQLクエリを考える:</p><pre><code class=language-sql>-- ListOrganizationMember :many
select user.* from user
inner join member on user.id = member.user_id
inner join organization on organization.id = member.organization_id
where organization.name = ?;

-- AddMember :exec
insert into member (user_id, organization_id) (?, ?);

-- RemoveMember :exec
delete from member where user_id = ? and organization_id = ?;
</code></pre><p>sqlcを用いると以下のようなGoの関数を生成できる:</p><pre><code class=language-go>package repository

// effect: select&lt;user, member, organization&gt;
func ListOrganizationMember(name string) ([]string, error)

// effect: insert&lt;member&gt;
func AddMember(string, string) error

// effect: delete&lt;member&gt;
func RemoveMember(string, string) error
</code></pre><p>ここではシグネチャしか記載していないが、実際には関数本体も生成される。関数につける作用の表明はバニラなsqlcではつかないのでプラグインを実装して対応したい。[^sqlc-use]</p><p>あとは普通にエフェクトを再帰的に計算して推論とチェックをすればいい。[^dirty]</p><h2><a href=#%e5%86%85%e9%83%a8%e5%ae%9f%e8%a3%85 id=内部実装 class=anchor aria-hidden=true>内部実装</a></h2><h3><a href=#%e3%82%a8%e3%83%95%e3%82%a7%e3%82%af%e3%83%88%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0 id=エフェクトシステム class=anchor aria-hidden=true>エフェクトシステム</a></h3><p>一応どんな感じにするとよさそうかをメモしておく。</p><h4><a href=#%e6%a6%82%e5%bf%b5%e3%81%ae%e5%ae%9a%e7%be%a9 id=概念の定義 class=anchor aria-hidden=true>概念の定義</a></h4><p>テーブル名は型として表現する。対象のSQLに出てくる全てのテーブル名をごそっと型として定義すれば良いだろう。<code>t</code> は型を表す。</p><pre><code>t ::= user | member | organization | ...
</code></pre><p>select とか insert とかは型を一つとって <strong>エフェクトラベル</strong> を返す型オペレータだと思うことにする。<code>l</code> はエフェクトラベルを表す。</p><pre><code>select: t -&gt; l
insert: t -&gt; l
delete: t -&gt; l
update: t -&gt; l
</code></pre><p><strong>エフェクト</strong>とは、エフェクトラベルの集合である。<code>eff</code> はエフェクトを表す。</p><pre><code>eff = setof l
</code></pre><h4><a href=#%e6%8e%a8%e8%ab%96 id=推論 class=anchor aria-hidden=true>推論</a></h4><p>関数とかパッケージ、式や文には一つのエフェクトを割り当てる。この割り当てる処理がエフェクトの<strong>推論</strong>である。プログラムの部分を実行したときに、そこで生じうる操作を表すのがエフェクトである。そういう気持ちで推論を定義する。</p><h5><a href=#%e6%96%87%e3%81%ae%e9%80%90%e6%ac%a1%e5%ae%9f%e8%a1%8c id=文の逐次実行 class=anchor aria-hidden=true>文の逐次実行</a></h5><p>文s1を実行して、文s2を実行するプログラムが <code>s1; s2</code> である。このプログラムの型とエフェクトをどのように推論するかを、以下の<code>推論規則</code>で定義する。</p><pre><code>s1: () | eff1  s2: () | eff2
-----------------------
s1; s2: () | eff1 + eff2
</code></pre><p>下側が結論であり、上の二つが仮定である。上が成り立つならば下が成り立つ、という図式。</p><p>下側の結論は 「<code>s1; s2</code> には型 <code>()</code> がつき、エフェクトは <code>eff1 + eff2</code> である」と解釈する。<code>+</code> は和集合をとる演算子とします。上の二つも同様である。</p><p>したがって、通しで読むと「<code>s1</code> に型 <code>()</code> がつき、エフェクトは <code>eff1</code> である。<code>s2</code> に型 <code>()</code> がつき、エフェクトは <code>eff2</code> であると仮定する。このとき <code>s1; s2</code> には型 <code>()</code> がつき、エフェクトは <code>eff1 + eff2</code> である。」となる。</p><h5><a href=#%e9%96%a2%e6%95%b0%e5%ae%9a%e7%be%a9 id=関数定義 class=anchor aria-hidden=true>関数定義</a></h5><pre><code>body: res | eff
--------------------------------------------------
func f(args: t1) res { body }: t1 -&gt; eff res | {}
</code></pre><p>関数の型は <code>&lt;引数の型> -> &lt;関数のエフェクト> 結果の型</code> という形をとる。関数定義自体の計算では何も操作しないためエフェクトは空。</p><h5><a href=#%e3%82%a2%e3%83%8e%e3%83%86%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3 id=アノテーション class=anchor aria-hidden=true>アノテーション</a></h5><pre><code>function: t1 -&gt; eff1 res | {}     eff1 &lt; eff
---------------------------------------------------
function // effect eff : () | eff
</code></pre><p>だんだん変数を考慮に入れてないことで無理が生じてきた。アノテーションをつけていたら、それが優先される。ただし、計算されたエフェクトがアノテーションの部分集合であることを要求する。</p><h2><a href=#%e5%ae%9f%e8%a3%85 id=実装 class=anchor aria-hidden=true>実装</a></h2><p>二つのコンポーネントに分けて実装している。</p><ul><li>エフェクトシステム: <a href=https://github.com/naoyafurudono/dirty>https://github.com/naoyafurudono/dirty</a></li><li>sqlcの解析: <a href=https://github.com/naoyafurudono/sqlc-use>https://github.com/naoyafurudono/sqlc-use</a></li></ul><p>エフェクトシステムはひとまず真面目に作らないで、ヒューリスティックに実装している。綺麗な方針じゃないのでdirtyと名付けた。作用という汚さをトラックするという気持ちももる（だったらtaintとかが普通か）。偽陽性・偽陰性がたくさん出そうだが、ある程度の範囲ならそれっぽく動くと目論んでいる。</p><p>sqlc-useはクエリがどんなテーブルに対してどんな操作をするかを分析してjsonに吐くやつ。コメントをつけるのは綺麗にできなさそうだった（sqlc-gen-go というプラグインに手を入れる必要がある）ので、別のプラグインとしてjsonファイルを生成して、エフェクトシステムがそれを読み込む方針に変えた。
dirtyがスキーマを定義して、それに適合する形式をsqlc-useが吐くべきなのだろうけど歴史的経緯によって今の構成にしている。一通り動くようになったらそうする。</p></p></div></div><footer class=footer-mobile><div class=social-icons><a class=social-icon href=https://twitter.com/furudono2 target=_blank rel=noopener title=Twitter><svg width="28" height="28" viewBox="0 0 28 28" fill="#ABABAB" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M8.991284 24.971612c10.189152.0 15.761088-8.441388 15.761088-15.761088C24.752372 8.970656 24.747512 8.731868 24.736496 8.494376 25.818008 7.712564 26.758256 6.737 27.5 5.62622c-.992628.440856-2.060748.738072-3.181248.871992 1.14372-.685584 2.02176-1.770768 2.435832-3.064176-1.070496.6345-2.25558 1.095984-3.517344 1.344492-1.010772-1.076652-2.450412-1.75014-4.043412-1.75014-3.059424.0-5.540292 2.480868-5.540292 5.539104.0.434808.0487079999999995.857412.14364 1.26306C9.19346 9.599108 5.11106 7.39472 2.3792 4.04294c-.476172.818424-.750168 1.769688-.750168 2.784132.0 1.921968.97794 3.61854 2.464992 4.61106C3.185528 11.41016 2.331788 11.160464 1.585184 10.745096 1.583888 10.768208 1.583888 10.791428 1.583888 10.815728c0 2.683152 1.909764 4.922856 4.4442 5.43078C5.562932 16.373084 5.07326 16.44134 4.56782 16.44134 4.210988 16.44134 3.863876 16.406024 3.526484 16.34144c.70524 2.200824 2.750112 3.802356 5.174928 3.8475-1.896264 1.485756-4.284576 2.37114-6.879924 2.37114C1.374476 22.56008.93362 22.534592.5 22.4834c2.451708 1.571076 5.362524 2.488212 8.491284 2.488212"/></svg>
</a><a class=social-icon href=https://www.instagram.com/donofuru/ target=_blank rel=noopener title=Instagram><svg width="28" height="28" viewBox="0 0 28 28" fill="#ABABAB" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M14.0000238 2.00378571c3.2579524.0 3.6664762.0138095300000001 4.946.0721904800000002C20.222881 2.13421429 21.0949286 2.33702381 21.8579762 2.63359524 22.6468333 2.94011905 23.3158333 3.35030952 23.9827857 4.01721429 24.6496905 4.68416667 25.059881 5.35316667 25.3664524 6.14202381 25.6629762 6.90507143 25.8657857 7.77711905 25.9240238 9.05397619 25.9824048 10.3335 25.9962143 10.7420238 25.9962143 14.0000238 25.9962143 17.2579762 25.9824048 17.6665 25.9240238 18.9460238 25.8657857 20.222881 25.6629762 21.0949286 25.3664524 21.8579762 25.059881 22.6468333 24.6496905 23.3158333 23.9827857 23.9827857 23.3158333 24.6496905 22.6468333 25.059881 21.8579762 25.3664524 21.0949286 25.6629762 20.222881 25.8657857 18.9460238 25.9240238 17.6665 25.9824048 17.2579762 25.9962143 14.0000238 25.9962143 10.7420238 25.9962143 10.3335 25.9824048 9.05397619 25.9240238 7.77711905 25.8657857 6.90507143 25.6629762 6.14202381 25.3664524 5.35316667 25.059881 4.68416667 24.6496905 4.01721429 23.9827857c-.66690477-.6669524-1.07709524-1.3359524-1.38361905-2.1248095-.29657143-.7630476-.49938095-1.6350952-.55761905-2.9119524C2.01759524 17.6665 2.00378571 17.2579762 2.00378571 14.0000238 2.00378571 10.7420238 2.01759524 10.3335 2.07597619 9.05397619 2.13421429 7.77711905 2.33702381 6.90507143 2.63359524 6.14202381c.30652381-.78885714.71671428-1.45785714 1.38361905-2.12480952.66695238-.66690477 1.33595238-1.07709524 2.12480952-1.38361905C6.90507143 2.33702381 7.77711905 2.13421429 9.05397619 2.07597619 10.3335 2.01759524 10.7420238 2.00378571 14.0000238 2.00378571zm0 2.16147619C10.796881 4.1652619 10.4174524 4.1775 9.1525 4.23521429 7.98288095 4.28854762 7.34769048 4.48397619 6.92497619 4.6482619 6.36502381 4.86588095 5.96540476 5.12583333 5.54564286 5.54564286c-.41980953.4197619-.67976191.81938095-.89738096 1.37933333-.16428571.42271429-.35971428 1.05790476-.41304761 2.22752381C4.1775 10.4174524 4.1652619 10.796881 4.1652619 14.0000238 4.1652619 17.203119 4.1775 17.5825476 4.23521429 18.8475 4.28854762 20.017119 4.48397619 20.6523095 4.6482619 21.0750238 4.86588095 21.6349762 5.12588095 22.0345952 5.54564286 22.4543571 5.96540476 22.8741667 6.36502381 23.134119 6.92497619 23.3517381 7.34769048 23.5160238 7.98288095 23.7114524 9.1525 23.7647857 10.4173095 23.8225 10.7966429 23.8347381 14.0000238 23.8347381 17.2033571 23.8347381 17.5827381 23.8225 18.8475 23.7647857 20.017119 23.7114524 20.6523095 23.5160238 21.0750238 23.3517381 21.6349762 23.134119 22.0345952 22.8741667 22.4543571 22.4543571 22.8741667 22.0345952 23.134119 21.6349762 23.3517381 21.0750238 23.5160238 20.6523095 23.7114524 20.017119 23.7647857 18.8475 23.8225 17.5825476 23.8347381 17.203119 23.8347381 14.0000238 23.8347381 10.796881 23.8225 10.4174524 23.7647857 9.1525 23.7114524 7.98288095 23.5160238 7.34769048 23.3517381 6.92497619 23.134119 6.36502381 22.8741667 5.96540476 22.4543571 5.54564286 22.0345952 5.12583333 21.6349762 4.86588095 21.0750238 4.6482619 20.6523095 4.48397619 20.017119 4.28854762 18.8475 4.23521429 17.5825476 4.1775 17.203119 4.1652619 14.0000238 4.1652619zm0 13.8334762c2.2084286.0 3.9987143-1.7902857 3.9987143-3.9987143.0-2.2084762-1.7902857-3.9987619-3.9987143-3.9987619-2.2084762.0-3.9987619 1.7902857-3.9987619 3.9987619.0 2.2084286 1.7902857 3.9987143 3.9987619 3.9987143zm0-10.15895239c3.4021905.0 6.1601905 2.75799999 6.1601905 6.16023809.0 3.4021905-2.758 6.1601905-6.1601905 6.1601905-3.4022381.0-6.16023809-2.758-6.16023809-6.1601905.0-3.4022381 2.75799999-6.16023809 6.16023809-6.16023809zm7.8431429-.24338095c0 .79504762-.644523800000002 1.43952381-1.4395715 1.43952381C19.6085952 9.03592857 18.9640714 8.39145238 18.9640714 7.59640476S19.6085952 6.15683333 20.4035952 6.15683333c.795047699999998.0 1.4395715.64452381 1.4395715 1.43957143z"/></svg>
</a><a class=social-icon href=https://www.linkedin.com/in/naoya-furudono target=_blank rel=noopener title=LinkedIn><svg width="28" height="28" viewBox="0 0 28 28" fill="#ABABAB" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M2 3.654102c0-.95502059.79442509-1.73012354 1.77383592-1.73012354H24.2261641C25.2058917 1.92397846 26 2.69908141 26 3.654102V24.3462148C26 25.3015521 25.2058917 26.0760215 24.2261641 26.0760215H3.77383592C2.79442509 26.0760215 2 25.3015521 2 24.3465315V3.65378524 3.654102zM9.27526132 22.1415901V11.2356668H5.65030092V22.1415901H9.27557808 9.27526132zM7.46341463 9.74691162c1.2638581.0 2.05068103-.83750395 2.05068103-1.88406715C9.49033893 6.79252455 8.72727273 5.97846056 7.48748812 5.97846056c-1.24073487.0-2.05099778.81406399-2.05099778 1.88438391.0 1.0465632.78650618 1.88406715 2.00316756 1.88406715h.02343998H7.46341463zM11.2815965 22.1415901h3.6246436v-6.089642C14.9062401 15.7263225 14.9299968 15.4000634 15.0256573 15.1675641c.261957499999999-.6515679.8584099-1.3259423 1.8599936-1.3259423 1.3113716.0 1.836237 1 1.836237 2.4662654v5.8337029h3.6246436V15.8885017c0-3.349699-1.7880899-4.9084574-4.172949-4.9084574-1.9553373.0-2.814064 1.0928097-3.2910991 1.8371872H14.9065569v-1.581248H11.2819132C11.3291099 12.2591067 11.2815965 22.1419069 11.2815965 22.1419069V22.1415901z"/></svg>
</a><a class=social-icon href=https://github.com/naoyafurudono target=_blank rel=noopener title=GitHub><svg width="28" height="28" viewBox="0 0 28 28" fill="#ABABAB" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M13.9988029 1.32087331C6.82105037 1.32087331 1 7.14112562 1 14.3212723c0 5.7436386 3.72454649 10.6157955 8.89038951 12.3348169C10.5408085 26.7757983 10.7778323 26.374374 10.7778323 26.0296121 10.7778323 25.7215609 10.7666595 24.9035493 10.760275 23.8189856 7.14426471 24.6042767 6.38131925 22.0760223 6.38131925 22.0760223c-.59136253-1.5019491-1.44369072-1.9017772-1.44369072-1.9017772C3.75729765 19.3682044 5.02701126 19.3841656 5.02701126 19.3841656 6.33183953 19.4759425 7.01817121 20.7241085 7.01817121 20.7241085c1.15958133 1.9863716 3.04300319 1.4125664 3.78360289 1.0797753.1181129-.8395592.4540962-1.4125663.8251942-1.7373768C8.74038491 19.7385043 5.70536235 18.6228163 5.70536235 13.6413251c0-1.4189508.50676816-2.5801283 1.33834679-3.4883207C6.90963504 9.82420367 6.46351945 8.50181809 7.17139875 6.71256734c0 0 1.09094816-.34955032 3.57451115 1.33276037C11.78259 7.75642995 12.8950858 7.61277914 14.000399 7.60719272 15.1049142 7.61277914 16.2166119 7.75642995 17.2548881 8.04532771c2.4819669-1.68231069 3.571319-1.33276037 3.571319-1.33276037C21.5356825 8.50181809 21.0895669 9.82420367 20.9562909 10.1530044 21.7894656 11.0611968 22.2922435 12.2223743 22.2922435 13.6413251c0 4.9942601-3.039811 6.0931889-5.935173 6.4148071.4660671.401424200000001.8818564 1.194696.8818564 2.4077473C17.2389269 24.2012564 17.2229657 25.603448 17.2229657 26.0296121 17.2229657 26.3775663 17.4575954 26.7821827 18.116793 26.6552912 23.2786458 24.9322794 27 20.0633148 27 14.3212723 27 7.14112562 21.1789496 1.32087331 13.9988029 1.32087331"/></svg></a></div><div class=footer-mobile-links><p><a href=https://github.com/naoyafurudono/naoyafurudono.github.io target=_blank rel=noopener>Source of
this site</a></p><span class=divider-bar>|</span><p><a href=https://gohugo.io target=_blank rel=noopener></a></p><p>©2025 Naoya Furudono</p></div><script src=https://blog.nfurudono.com/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script><a target=_blank rel="noopener noreferrer" href=https://github.com/naoyafurudono/naoyafurudono.github.io/actions><img src=https://github.com/naoyafurudono/naoyafurudono.github.io/actions/workflows/gh-pages.yml/badge.svg alt="github pages deploy status" style=max-width:100%></a><p><a href="https://www.amazon.jp/hz/wishlist/ls/1JBRXP4JZZ21T?ref_=wl_share">欲しい本リスト</a></p><p><a href="https://www.amazon.jp/hz/wishlist/ls/3TT5GR81VZPHP?ref_=wl_share">欲しいものリスト</a></p></footer></body></html>